// A2ARestaurantOfficialHandler.ets
import { WebNetErrorList, webview } from '@kit.ArkWeb';
import { BusinessError } from '@kit.BasicServicesKit';
import { buffer } from '@kit.ArkTS';

/**
 * A2Aé¤å…æŸ¥æ‰¾å™¨ - åŸºäºåä¸ºå®˜æ–¹WebSchemeHandler API
 * ä¸¥æ ¼éµå¾ªä½ æä¾›çš„å®˜æ–¹ä»£ç ç»“æ„
 */
interface GeneratedTypeLiteralInterface_1 {
  headerKey: string;
  headerValue: string;
}

@Component
export struct A2ARestaurantOfficialHandler {
  controller: webview.WebviewController = new webview.WebviewController();
  schemeHandler: webview.WebSchemeHandler = new webview.WebSchemeHandler();

  // çŠ¶æ€æ˜¾ç¤º
  @State private capturedCount: number = 0;
  @State private lastA2AData: string = '';
  @State private isProcessing: boolean = false;

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ğŸ” A2Aé¤å…æ‹¦æˆªå™¨ï¼ˆå®˜æ–¹APIï¼‰')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1976D2')

        Text(`å·²æ•è·: ${this.capturedCount}`)
          .fontSize(14)
          .fontColor('#4CAF50')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#E3F2FD')
      .justifyContent(FlexAlign.SpaceBetween)

      // WebView
      Web({ src: 'http://172.28.128.1:5173', controller: this.controller })
        .width('100%')
        .height('60%')
        .onControllerAttached(() => {
          this.setupOfficialA2AInterceptor();
        })

      // æ•°æ®æ˜¾ç¤º
      Column() {
        Text('ğŸ“Š æœ€æ–°A2Aæ•°æ®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 8 })

        Scroll() {
          Column() {
            if (this.lastA2AData) {
              Text(this.lastA2AData)
                .fontSize(10)
                .fontFamily('monospace')
                .backgroundColor('#F5F5F5')
                .padding(8)
                .borderRadius(4)
                .width('100%')
            } else {
              Text('â³ ç­‰å¾…A2Aè¯·æ±‚...')
                .fontSize(12)
                .fontColor('#757575')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
          }
        }
        .height(200)

        Text('ğŸ’¡ æç¤º: è¾“å…¥"å¸®æˆ‘æ‰¾é¤é¦†"è§¦å‘A2Aè¯·æ±‚')
          .fontSize(12)
          .fontColor('#757575')
          .margin({ top: 8 })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FAFAFA')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * è®¾ç½®A2Aæ‹¦æˆªå™¨
   */
  private setupOfficialA2AInterceptor(): void {
    console.info('ğŸš€ è®¾ç½®å®˜æ–¹A2Aæ‹¦æˆªå™¨');

    try {
      // ä½¿ç”¨å®˜æ–¹APIï¼šonRequestStart
      this.schemeHandler.onRequestStart((request: webview.WebSchemeHandlerRequest, resourceHandler: webview.WebResourceHandler) => {

        console.info('[A2A] onRequestStartå¼€å§‹');

        try {
          // è·å–è¯·æ±‚åŸºæœ¬ä¿¡æ¯ - ä½¿ç”¨å®˜æ–¹APIæ–¹æ³•
          const url: string = request.getRequestUrl();
          const method: string = request.getRequestMethod();
          const headers = request.getHeader(); // å®˜æ–¹æ ¼å¼ï¼šæ•°ç»„

          console.info(`[A2A] URL: ${url}`);
          console.info(`[A2A] Method: ${method}`);

          // åªå¤„ç†POSTè¯·æ±‚
          if (method === 'POST') {
            // æ£€æŸ¥æ˜¯å¦ä¸ºA2Aè¯·æ±‚
            if (this.isA2APostRequest(url, headers)) {
              console.info('[A2A] è¯†åˆ«åˆ°A2A POSTè¯·æ±‚');
              this.captureA2ARequest(request, resourceHandler);
              return true; // è¿”å›trueè¡¨ç¤ºæ‹¦æˆª
            }
          }

        } catch (error) {
          console.error(`[A2A] è¯·æ±‚å¤„ç†é”™è¯¯: ${(error as BusinessError).code}, ${(error as BusinessError).message}`);
        }

        return false; // è¿”å›falseè¡¨ç¤ºä¸æ‹¦æˆª
      })

      // è®¾ç½®è¯·æ±‚ç»“æŸå›è°ƒï¼ˆå®˜æ–¹APIï¼‰
      this.schemeHandler.onRequestStop((request: webview.WebSchemeHandlerRequest) => {
        console.info('[A2A] onRequestStop');
      })

      // ç»‘å®šåˆ°httpsåè®®ï¼ˆå®˜æ–¹æ–¹å¼ï¼‰
      this.controller.setWebSchemeHandler('https', this.schemeHandler);
      console.info('âœ… å®˜æ–¹A2Aæ‹¦æˆªå™¨è®¾ç½®å®Œæˆ');

    } catch (error) {
      console.error(`[A2A] è®¾ç½®å¤±è´¥: ${(error as BusinessError).code}, ${(error as BusinessError).message}`);
    }
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºA2A POSTè¯·æ±‚
   * @param url - è¯·æ±‚URL
   * @param headers - è¯·æ±‚å¤´æ•°ç»„ï¼ˆå®˜æ–¹æ ¼å¼ï¼‰
   */
  private isA2APostRequest(url: string, headers: Array<GeneratedTypeLiteralInterface_1>): boolean {
    // æ£€æŸ¥URLç‰¹å¾
    const isA2AUrl = url.includes('/a2a/') || url.includes('jsonrpc') || url.includes('/a2a/jsonrpc');

    // æ£€æŸ¥Content-Typeï¼ˆå®˜æ–¹æ ¼å¼ï¼šæ•°ç»„ï¼‰
    let contentType = '';
    for (const header of headers) {
      if (header.headerKey.toLowerCase() === 'content-type') {
        contentType = header.headerValue;
        break;
      }
    }
    const isJson = contentType.includes('application/json');

    const result = isA2AUrl && isJson;
    if (result) {
      console.info(`[A2A] ç¡®è®¤A2Aè¯·æ±‚: ${url}`);
    }
    return result;
  }

  /**
   * æ•è·A2Aè¯·æ±‚æ•°æ®
   * åŸºäºå®˜æ–¹APIå®ç°
   */
  private async captureA2ARequest(
    request: webview.WebSchemeHandlerRequest,
    resourceHandler: webview.WebResourceHandler
  ): Promise<void> {
    try {
      this.isProcessing = true;
      console.info('=== ğŸ“¨ A2Aè¯·æ±‚æ•è·å¼€å§‹ ===');

      // è·å–è¯·æ±‚å¤´ï¼ˆå®˜æ–¹æ ¼å¼ï¼‰
      const headers = request.getHeader();
      console.info(`[A2A] è¯·æ±‚å¤´æ•°é‡: ${headers.length}`);

      // æŸ¥æ‰¾Content-Type
      let contentType = '';
      for (const header of headers) {
        if (header.headerKey.toLowerCase() === 'content-type') {
          contentType = header.headerValue;
          console.info(`[A2A] Content-Type: ${contentType}`);
          break;
        }
      }

      // è·å–è¯·æ±‚ä½“æµ - å®˜æ–¹API
      let stream = request.getHttpBodyStream();
      if (stream) {
        stream.initialize().then(() => {
          if (!stream) {
            return;
          }
          console.info("[schemeHandler] onRequestStart postDataStream size:" + stream.getSize());
          console.info("[schemeHandler] onRequestStart postDataStream position:" + stream.getPosition());
          console.info("[schemeHandler] onRequestStart postDataStream isChunked:" + stream.isChunked());
          console.info("[schemeHandler] onRequestStart postDataStream isEof:" + stream.isEof());
          console.info("[schemeHandler] onRequestStart postDataStream isInMemory:" + stream.isInMemory());
          stream.read(stream.getSize()).then((buffer) => {
            if (!stream) {
              return;
            }
            console.info("[schemeHandler] onRequestStart postDataStream readlength:" + buffer.byteLength);
            console.info("[schemeHandler] onRequestStart postDataStream isEof:" + stream.isEof());
            console.info("[schemeHandler] onRequestStart postDataStream position:" + stream.getPosition());
            const uint8Array = new Uint8Array(buffer);
            let bodyText = this.arrayBufferToString(uint8Array);
            this.parseA2AJSON(bodyText);
          }).catch((error: BusinessError) => {
            console.error(`ErrorCode: ${error.code},  Message: ${error.message}`);
          })
        }).catch((error: BusinessError) => {
          console.error(`ErrorCode: ${error.code},  Message: ${error.message}`);
        })
      } else {
        console.info("[schemeHandler] onRequestStart has no http body stream");
      }

      this.capturedCount++;
      console.info('âœ… A2Aè¯·æ±‚æ•è·å®Œæˆ');

    } catch (error) {
      console.error('[A2A] æ•è·å¤±è´¥:', error);
    } finally {
      this.isProcessing = false;

      // å¿…é¡»æä¾›å“åº” - å®˜æ–¹è¦æ±‚
      this.provideA2AResponse(resourceHandler);
    }
  }



  // åªä¿®æ­£æŠ¥é”™çš„ parseA2AJSON å‡½æ•°
  private parseA2AJSON(bodyText: string): void {
    try {
      const trimmedData = bodyText.trim();
      if (!trimmedData) {
        console.info('[A2A] JSONæ•°æ®ä¸ºç©º');
        return;
      }

      // ä½¿ç”¨æ˜ç¡®çš„ç±»å‹å®šä¹‰æ›¿ä»£ any
      const jsonData: Record<string, Object> = JSON.parse(trimmedData);

      // å®‰å…¨è®¿é—®å±æ€§ï¼Œé¿å… any ç±»å‹
      const jsonrpc: string = typeof jsonData.jsonrpc === 'string' ? jsonData.jsonrpc : '';
      const method: string = typeof jsonData.method === 'string' ? jsonData.method : '';
      const id: string | number = jsonData.id !== undefined ? jsonData.id as string | number : '';

      console.info('=== ğŸ“‹ A2A JSON-RPCæ•°æ® ===');
      console.info(`[A2A] JSON-RPCç‰ˆæœ¬: ${jsonrpc}`);
      console.info(`[A2A] æ–¹æ³•å: ${method}`);
      console.info(`[A2A] è¯·æ±‚ID: ${id}`);

      // è®°å½•å®Œæ•´æ ¼å¼åŒ–æ•°æ®
      const formattedData: string = JSON.stringify(jsonData, null, 2);
      console.info('[A2A] å®Œæ•´æ•°æ®:\n', formattedData);

      // æ›´æ–°UIæ˜¾ç¤º
      this.lastA2AData = formattedData;

      // å®‰å…¨åˆ†æé¤å…è¯·æ±‚
      this.analyzeRestaurantRequest(jsonData);

    } catch (error) {
      console.error('[A2A] JSONè§£æå¤±è´¥:', bodyText.substring(0, 100));
    }
  }

  /**
   * å®‰å…¨åˆ†æé¤å…è¯·æ±‚
   * ä½¿ç”¨æ˜ç¡®çš„ç±»å‹é¿å… any
   */
  private analyzeRestaurantRequest(jsonData: Record<string, Object>): void {
    try {
      // å®‰å…¨è·å– method
      const method: string = typeof jsonData.method === 'string' ? jsonData.method : '';

      if (method === 'SendMessage') {
        // å®‰å…¨è·å– params
        const params: Record<string, Object> = jsonData.params as Record<string, Object> || {};
        const message: Record<string, Object> = params.message as Record<string, Object> || {};
        const parts: Array<Object> = message.parts as Array<Object> || [];

        if (parts.length > 0) {
          const part: Record<string, Object> = parts[0] as Record<string, Object> || {};
          const userText: string = typeof part.text === 'string' ? part.text as string : '';

          console.info(`[A2A] ç”¨æˆ·æ¶ˆæ¯: "${userText}"`);

          // æ£€æŸ¥é¤å…å…³é”®è¯
          const keywords: string[] = ['é¤å…', 'restaurant', 'åƒé¥­', 'è®¢é¤', 'æ‰¾é¤é¦†', 'restaurants'];
          const isRestaurant: boolean = keywords.some((k: string) =>
          userText.toLowerCase().includes(k.toLowerCase())
          );

          if (isRestaurant) {
            console.info('[A2A] ğŸ½ï¸ æ£€æµ‹åˆ°é¤å…æŸ¥æ‰¾è¯·æ±‚ï¼');
            console.info('[A2A] ğŸ¯ æˆåŠŸæˆªè·"å¸®æˆ‘æ‰¾é¤é¦†"çš„A2Aè¯·æ±‚ï¼');
          }
        }
      }
    } catch (error) {
      console.error('[A2A] åˆ†æå¤±è´¥:', error);
    }
  }

  /**
   * æä¾›A2Aå“åº” - å®˜æ–¹æ–¹å¼
   */
  private provideA2AResponse(handler: webview.WebResourceHandler): void {
    try {
      console.info('[A2A] æä¾›å“åº”');

      // åˆ›å»ºå“åº” - å®˜æ–¹æ–¹å¼
      const response = new webview.WebSchemeHandlerResponse();
      response.setStatus(200);
      response.setStatusText('OK');
      response.setMimeType('application/json');
      response.setEncoding('utf-8');

      // è®¾ç½®å“åº”å¤´
      response.setHeaderByName('X-Captured', 'true', false);
      response.setHeaderByName('Access-Control-Allow-Origin', '*', false);

      // å“åº”æ•°æ®
      const responseData = JSON.stringify({
        status: 'captured',
        timestamp: new Date().toISOString(),
        message: 'A2A request logged by ArkTS'
      });

      // è½¬æ¢æ•°æ® - å®˜æ–¹æ–¹å¼
      const buf = buffer.from(responseData);

      // æŒ‰å®˜æ–¹é¡ºåºå‘é€å“åº”
      handler.didReceiveResponse(response);
      handler.didReceiveResponseBody(buf.buffer);
      handler.didFinish();

      console.info('[A2A] å“åº”å‘é€å®Œæˆ');

    } catch (error) {
      console.error('[A2A] å“åº”å‘é€å¤±è´¥:', error);
      handler.didFail(WebNetErrorList.ERR_FAILED);
    }
  }

  /**
   * ArrayBufferè½¬å­—ç¬¦ä¸²
   */
  private arrayBufferToString(uint8Array: Uint8Array): string {
    let result = '';
    for (let i = 0; i < uint8Array.length; i++) {
      result += String.fromCharCode(uint8Array[i]);
    }
    return result;
  }
}