// A2UIInArkWeb.ets  (å®Œæ•´å•æ–‡ä»¶)
import { webview } from '@kit.ArkWeb';

/* æ­¥éª¤ 3 ï¼š ArkWeb ç›´æ¥åŠ è½½æœ¬åœ°æ–‡ä»¶  */
@Component
export struct A2UIInArkWeb {
  // 1.  WebView æ§åˆ¶å™¨
  private controller: webview.WebviewController = new webview.WebviewController();
  // 3.  ç”¨äº UI çš„çŠ¶æ€
  @State private lastA2UData: string = '';
  @State private msgCount: number = 0;
  schemeMap = new Map([
    ['https://www.locala2uiywh.com/index.html','a2ui/dist/index.html'],
    ['https://www.locala2uiywh.com/assets/app.js','a2ui/dist/assets/app.js'],
    ['https://www.locala2uiywh.com/hero.png','a2ui/dist/hero.png'],
    ['https://www.locala2uiywh.com/hero-dark.png','a2ui/dist/hero-dark.png'],
    // ['http://localhost:10002/.well-known/agent-card.json','a2ui/dist/agent-card.json'],
  ]);

  mimeType = new Map([
    ['a2ui/dist/index.html', 'text/html'],
    ['a2ui/dist/assets/app.js', 'text/javascript'],
    ['a2ui/dist/hero.png', 'image/png'],
    ['a2ui/dist/hero-dark.png', 'image/png'],
    ['a2ui/dist/agent-card.json', 'application/json'],
  ])



  /* ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢åŠ è½½å®Œæˆåæ³¨å…¥æ¡¥æ¥è„šæœ¬ */
  aboutToAppear() {

  }

  /* å‘ A2UI ä¾§æ³¨å…¥ JavaScript æ¡¥æ¥å¯¹è±¡ï¼Œä¾› HTML è°ƒç”¨ */
  private injectArkTSBridge(): void {
    const bridgeJS: string = `
      window.arktsBridge = {
        /* A2UI â†’ ArkTS ï¼šå‘é€ JSON-RPC æ¶ˆæ¯  */
        sendA2UMessage: function(jsonRpc) {
          if (window.arktsBridge && window.arktsBridge.receiveFromA2U) {
            window.arktsBridge.receiveFromA2U(jsonRpc);
          }
        },
        /* ArkTS â†’ A2UI ï¼šå›ä¼ å“åº”  */
        sendResponseToA2U: function(response) {
          if (window.handleArkTSResponse) window.handleArkTSResponse(response);
        }
      };
      console.log('[A2UI] ArkTS æ¡¥æ¥å·²å»ºç«‹');
    `;
    this.controller.runJavaScript(bridgeJS);
  }

  // /* æ³¨å†Œ JavaScript ä»£ç†ï¼š ArkTS â†’ A2UI  */
  // private setupJSProxy(): void {
  //   this.controller.registerJavaScriptProxy({
  //     name: 'arktsBridge',
  //     object: {
  //       receiveFromA2U: (jsonRpc: string) => {
  //         /* æ”¶åˆ° A2UI å‘æ¥çš„ JSON-RPC ï¼Œè§£æå¹¶å›åŒ…  */
  //         this.handleA2UMessage(jsonRpc);
  //       }
  //     },
  //     methodList: ['receiveFromA2U'],
  //     controller: this.controller
  //   });
  // }

  // /* è§£æ A2U JSON-RPC å¹¶å›åŒ…  */
  // private handleA2UMessage(jsonRpc: string): void {
  //   try {
  //     const msg: Record<string, Object> = JSON.parse(jsonRpc) as Record<string, Object>;
  //     const method: string = typeof msg.method === 'string' ? msg.method : '';
  //     const id: string | number = msg.id !== undefined ? msg.id as string | number : '';
  //
  //     console.info(`[A2UI] æ”¶åˆ°æ–¹æ³•ï¼š${method}`);
  //
  //     /* æ¨¡æ‹Ÿå“åº”ï¼šé¤å…åˆ—è¡¨  */
  //     const response: Record<string, Object> = {
  //       jsonrpc: '2.0',
  //       id: id,
  //       result: {
  //         kind: 'a2ui',
  //         messages: [
  //           {
  //             surfaceUpdate: {
  //               surfaceId: 'main',
  //               components: [
  //                 {
  //                   id: 'list',
  //                   component: {
  //                     Column: {
  //                       children: { explicitList: ['title', 'r1', 'r2'] }
  //                     }
  //                   }
  //                 },
  //                 {
  //                   id: 'title',
  //                   component: {
  //                     Text: { text: { literalString: 'ğŸ½ï¸ æ¨èé¤å…' }, usageHint: 'h2' }
  //                   }
  //                 },
  //                 {
  //                   id: 'r1',
  //                   component: {
  //                     Card: {
  //                       title: { literalString: 'Luigi æ„å¤§åˆ©å¨æˆ¿' },
  //                       subtitle: { literalString: 'æ‰‹å·¥æ„é¢ Â· 4.5â˜…' },
  //                       content: { literalString: 'åœ°å€ï¼šAè¡—1å·' }
  //                     }
  //                   }
  //                 },
  //                 {
  //                   id: 'r2',
  //                   component: {
  //                     Card: {
  //                       title: { literalString: 'Mario æŠ«è¨å±‹' },
  //                       subtitle: { literalString: 'ç‚­çƒ¤æŠ«è¨ Â· 4.7â˜…' },
  //                       content: { literalString: 'åœ°å€ï¼šBè¡—2å·' }
  //                     }
  //                   }
  //                 }
  //               ]
  //             }
  //           },
  //           { beginRendering: { surfaceId: 'main', root: 'list' } }
  //         ]
  //       }
  //     };
  //
  //     /* å›ä¼  A2UI  */
  //     const script: string = `arktsBridge.sendResponseToA2U(${JSON.stringify(response)})`;
  //     this.controller.runJavaScript(script);
  //
  //     /* UI çŠ¶æ€æ›´æ–°  */
  //     this.lastA2UData = JSON.stringify(response, null, 2);
  //     this.msgCount++;
  //
  //   } catch (e) {
  //     console.error('[A2UI] å¤„ç†å¤±è´¥', e);
  //   }
  // }

  /* UI æ„å»º  */
  build() {
    Column() {
      /* æ ‡é¢˜æ   */
      Row() {
        Column() {
          Text('ğŸ½ï¸ A2UI å®Œæ•´åº”ç”¨ï¼ˆArkWeb å†…è¿è¡Œï¼‰')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1976D2')
          Text(`æ¶ˆæ¯è®¡æ•°ï¼š${this.msgCount}  |  æœ¬åœ° rawfile åŠ è½½`)
            .fontSize(12)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        if (this.msgCount > 0) {
          Text('âœ… å·²äº¤äº’')
            .fontSize(12)
            .fontColor('#4CAF50')
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#E3F2FD')

      /* A2UI Web å†…å®¹ï¼ˆæœ¬åœ° index.htmlï¼‰  */
      Web({ src: 'https://www.localA2UIywh.com/index.html', controller: this.controller }).fileAccess(true)
        .geolocationAccess(true)
        .javaScriptAccess(true)          // å…è®¸ JS
        .domStorageAccess(true)          // å…è®¸ localStorage
        .onControllerAttached(() => {
        })
        .onInterceptRequest((event) => {
          console.info(`[A2UI] InterceptRequest enters`);
          if (!event) {
            return;
          }
          console.info(`[A2UI] getRequestUrl:${event.request.getRequestUrl()}`);
          if (this.schemeMap.has(event.request.getRequestUrl())) {
            let railFileName:string = this.schemeMap.get(event.request.getRequestUrl())!;
            console.info(`[A2UI] rawfilename:${railFileName}`);
            let mimeType = this.mimeType.get(railFileName);
            console.info(`[A2UI] mimeType:${mimeType}`);
            if (typeof mimeType === 'string') {
              console.info(`[A2UI] begin setResponse`);
              let response = new WebResourceResponse();
              response.setResponseData($rawfile(railFileName));
              response.setResponseEncoding('utf-8');
              response.setResponseMimeType(mimeType);
              response.setResponseCode(200);
              response.setReasonMessage('OK');
              response.setResponseIsReady(true);
              return response;
            }
          }
          return null;
        })
        .width('100%')
        .height('70%')
        .onPageEnd(() => {
          console.info('[A2UI] æœ¬åœ° index.html åŠ è½½å®Œæˆ');
          // this.setupJSProxy();           // é¡µé¢åŠ è½½åæ³¨å†Œä»£ç†
        })
        .onErrorReceive((event) => {
          console.error('[A2UI] é¡µé¢é”™è¯¯', event.error);
        })

      /* çŠ¶æ€é¢æ¿ï¼šæ˜¾ç¤ºæœ€æ–° A2UI æ•°æ®  */
      Column() {
        Text('ğŸ“Š æœ€æ–° A2UI æ•°æ®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 8 })

        Scroll() {
          Column() {
            if (this.lastA2UData) {
              Text(this.lastA2UData)
                .fontSize(10)
                .fontFamily('monospace')
                .backgroundColor('#F5F5F5')
                .padding(8)
                .borderRadius(4)
                .width('100%')
            } else {
              Text('â³ ç­‰å¾… A2UI äº¤äº’ â€¦')
                .fontSize(12)
                .fontColor('#757575')
                .width('100%')
                .textAlign(TextAlign.Center)
            }
          }
        }
        .width('100%')

        Text('ğŸ’¡ åœ¨ä¸Šæ–¹ Web ä¸­è¾“å…¥â€œå¸®æˆ‘æ‰¾é¤é¦†â€è§¦å‘ A2UI äº¤äº’')
          .fontSize(11)
          .fontColor('#757575')
          .margin({ top: 8 })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FAFAFA')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}