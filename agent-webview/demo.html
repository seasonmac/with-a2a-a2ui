<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agent WebView</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        #app {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .status.pending { background: #fff3cd; color: #856404; }
        .status.ready { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .message.agent {
            background: #e9ecef;
            color: #333;
        }
        
        .message.working {
            background: #fff3cd;
            color: #856404;
            font-style: italic;
        }
        
        .input-area {
            display: flex;
            padding: 12px;
            border-top: 1px solid #eee;
            gap: 8px;
        }
        
        .input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }
        
        .input-area input:focus {
            border-color: #007bff;
        }
        
        .input-area button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .debug-panel {
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .debug-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="status" class="status pending">
            ⏳ 等待初始化...
        </div>
        
        <div class="chat-container">
            <div id="messages" class="messages">
                <!-- 消息将在这里显示 -->
            </div>
            
            <div class="input-area">
                <input type="text" id="input" placeholder="输入消息..." disabled>
                <button id="send" disabled>发送</button>
            </div>
        </div>
        
        <div class="debug-panel">
            <strong>调试信息:</strong>
            <pre id="debug">等待...</pre>
        </div>
    </div>
    
    <!-- 加载打包后的 Agent -->
    <script src="./dist/agent-webview.js"></script>
    
    <script>
        // UI 元素
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const debugEl = document.getElementById('debug');
        
        // 调试日志
        function log(msg) {
            debugEl.textContent = msg;
            console.log('[Demo]', msg);
        }
        
        // 添加消息到 UI
        function addMessage(text, type = 'agent') {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // 初始化 Agent
        async function initAgent() {
            log('正在初始化 Agent...');
            
            // 模拟配置（实际使用时由 Native 注入）
            const config = {
                // 这些配置应该由 Native 端注入
                // GEMINI_API_KEY: 'your-api-key',
                // GEMINI_BASE_URL: 'https://api.openai.com/v1',
                // GEMINI_MODEL: 'gpt-4',
                baseUrl: window.location.origin
            };
            
            try {
                const result = await window.AgentWebView.initialize(config);
                
                if (result.success) {
                    statusEl.className = 'status ready';
                    statusEl.textContent = `✅ Agent 已就绪 (Session: ${result.sessionId})`;
                    inputEl.disabled = false;
                    sendBtn.disabled = false;
                    log(`初始化成功: ${JSON.stringify(result)}`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ 初始化失败: ${error.message}`;
                log(`初始化失败: ${error.message}`);
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const text = inputEl.value.trim();
            if (!text) return;
            
            // 禁用输入
            inputEl.disabled = true;
            sendBtn.disabled = true;
            inputEl.value = '';
            
            // 显示用户消息
            addMessage(text, 'user');
            log(`发送消息: ${text}`);
            
            try {
                // 使用 AgentWebView API
                await window.AgentWebView.sendTextMessage(text, true);
            } catch (error) {
                addMessage(`错误: ${error.message}`, 'error');
                log(`发送失败: ${error.message}`);
            } finally {
                inputEl.disabled = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        }
        
        // 监听 Agent 事件
        window.AgentWebView.on('event', (event) => {
            log(`收到事件: ${JSON.stringify(event).substring(0, 200)}...`);
            
            if (event.type === 'working') {
                // 更新或添加工作状态消息
                let workingMsg = messagesEl.querySelector('.message.working');
                if (!workingMsg) {
                    workingMsg = document.createElement('div');
                    workingMsg.className = 'message working';
                    messagesEl.appendChild(workingMsg);
                }
                workingMsg.textContent = event.message;
            } else if (event.type === 'complete') {
                // 移除工作状态消息
                const workingMsg = messagesEl.querySelector('.message.working');
                if (workingMsg) workingMsg.remove();
                
                // 显示完成的消息
                if (event.parts) {
                    event.parts.forEach(part => {
                        if (part.kind === 'text') {
                            addMessage(part.text, 'agent');
                        } else if (part.kind === 'data') {
                            addMessage(`[UI 数据] ${JSON.stringify(part.data).substring(0, 100)}...`, 'agent');
                        }
                    });
                }
            }
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
        });
        
        window.AgentWebView.on('error', (error) => {
            log(`错误: ${error.message}`);
            addMessage(`错误: ${error.message}`, 'error');
        });
        
        // 事件绑定
        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // 启动
        initAgent();
    </script>
</body>
</html>
